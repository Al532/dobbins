<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dobbins : Arrangement jazz</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Zone texte et zone image -->
  <div class="content" id="content"></div>
  <div class="sidebar" id="sidebar"></div>

  <!-- Librairie Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Ton texte en Markdown -->
  <script src="texte.js"></script>

  <script>
    // Conversion du Markdown en HTML
    let html = marked.parse(MARKDOWN);

    // Transformer les liens audio en lecteur personnalisé
    html = html.replace(
      /<a href="([^"]+\.mp3)(?:\?start=(\d+(?:\.\d+)?))?">([\s\S]*?)<\/a>/g,
      (match, src, start, text) => {
        const startTime = parseFloat(start) || 0;
        const label = text.trim() || "Audio";
        return `
          <div class="audio-player" data-start="${startTime}">
            <div class="audio-label">${label}</div>
            <div class="audio-controls">
              <button class="play-btn">►</button>
              <div class="progress"><div class="progress-filled"></div></div>
              <audio src="${src}"></audio>
            </div>
          </div>`;
      }
    );

    // Transformer les liens image pour sidebar
    html = html.replace(
      /<a href="([^"]+\.(?:jpg|png|gif))">([\s\S]*?)<\/a>/g,
      (match, src, text) => {
        return `<a href="#" data-image="${src}">${text}</a>`;
      }
    );

    // Injecter le contenu dans la page
    document.getElementById("content").innerHTML = html;

    // Initialiser les interactions
    initInteractions();

    function initInteractions() {
      const sidebar = document.getElementById('sidebar');
      sidebar.style.backgroundImage = 'url(1.jpg)'; // image par défaut

      // Gestion des ancres internes
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', e => {
          e.preventDefault();
          const target = document.getElementById(anchor.getAttribute('href').substring(1));
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      });

      // Gestion des images cliquées (affichage dans la sidebar)
      document.querySelectorAll('.content a[data-image]').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          sidebar.style.backgroundImage = `url(${link.dataset.image})`;
        });
      });

      // Gestion des lecteurs audio
      document.querySelectorAll('.audio-player').forEach(player => {
        const audio = player.querySelector('audio');
        const playBtn = player.querySelector('.play-btn');
        const progress = player.querySelector('.progress');
        const progressFilled = player.querySelector('.progress-filled');
        const startTime = parseFloat(player.dataset.start) || 0;

        // Position de départ
        audio.addEventListener('loadedmetadata', () => audio.currentTime = startTime);

        // Play/pause
        playBtn.addEventListener('click', () => {
          if (audio.paused) {
            // Stopper les autres lecteurs
            document.querySelectorAll('.audio-player').forEach(other => {
              const otherAudio = other.querySelector('audio');
              if (otherAudio !== audio) {
                otherAudio.pause();
                otherAudio.currentTime = parseFloat(other.dataset.start) || 0;
                const otherBtn = other.querySelector('.play-btn');
                if (otherBtn) otherBtn.textContent = '►';
                const otherProgress = other.querySelector('.progress-filled');
                if (otherProgress) otherProgress.style.width = '0%';
              }
            });
            audio.play();
            playBtn.textContent = '❚❚';
          } else {
            audio.pause();
            audio.currentTime = startTime;
            playBtn.textContent = '►';
            progressFilled.style.width = '0%';
          }
        });

        // Avancement du curseur
        audio.addEventListener('timeupdate', () => {
          progressFilled.style.width = (audio.currentTime / audio.duration) * 100 + '%';
        });

        // Clic sur la barre de progression
        progress.addEventListener('click', e => {
          const ratio = (e.clientX - progress.getBoundingClientRect().left) / progress.offsetWidth;
          audio.currentTime = ratio * audio.duration;
        });

        // Fin de la lecture
        audio.addEventListener('ended', () => {
          playBtn.textContent = '►';
          progressFilled.style.width = '0%';
        });
      });
    }
  </script>
</body>
</html>
